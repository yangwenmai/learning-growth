## 精选留言

### 到底应该怎么理解“平均负载”？

**倪朋飞**

2018-11-25

1. iowait无法升高的问题，是因为案例中stress使用的是 sync() 系统调用，它的作用是刷新缓冲区内存到磁盘中。对于新安装的虚拟机，缓冲区可能比较小，无法产生大的IO压力，这样大部分就都是系统调用的消耗了。所以，你会看到只有系统CPU使用率升高。解决方法是使用stress的下一代stress-ng，它支持更丰富的选项，比如 stress-ng -i 1 --hdd 1 --timeout 600（--hdd表示读写临时文件）。
2. pidstat输出中没有%wait的问题，是因为CentOS默认的sysstat稍微有点老，源码或者RPM升级到11.5.5版本以后就可以看到了。而Ubuntu的包一般都比较新，没有这个问题。
3. mpstat无法观测的问题，案例中是等待5秒后输出1次结果就停止了，更好的做法是持续监控一段时间，比如持续观测20次：mpstat -P ALL 5 20。

**冯宇：**

2018-11-23

我一直用htop看负载，因为它更直接（在F2配置中勾选所有开关项，打开颜色区分功能），不同的负载会用不同的颜色标识。比如cpu密集型的应用，它的负载颜色是绿色偏高，iowait的操作，它的负载颜色是红色偏高等等，根据这些指标再用htop的sort就很容易定位到有问题的进程。还有个更好用的atop命令，好像是基于sar的统计生成的报告，直接就把有问题的进程标红了，更直观

**shellmode**

2018-11-23

在 sched/loadavg.c 中计算平均值的算法为EMA，这种算法的目的主要是“距离目标预测窗口越近，则数据的价值越高，对未来影响越大”如果说“更快的计算”应该只有里面的 fixed_power_int 函数用 O(log n) 的时间来算 x^n所以内核中用 EMA 来算 loadavg 本质上并不是增加计算性能，而是让 loadavg 的趋势化更明显

**孤岛**

2018-11-23

我有一点自己的理解，请老师指正。CPU比喻成一辆地铁，正在使用CPU的进程就是在地铁上的人；等待CPU的进程就是在下一站等地铁来的人；等待I/O的进程就是在下一站要上车和下车的人，虽然现在对CPU没影响，可未来会影响，所以也要考虑到平均负载上。

作者回复: 很好的比喻，补充一下这个地铁的乘客容量就是CPU个数

**DJH**

2018-11-23

老师你好，请教一个问题，现在大多数CPU有超线程能力，在计算和评估平均负载的时候，CPU的核数是指物理核数，还是超线程功能的逻辑核数？

作者回复: 逻辑核数

**杨领well**

2019-06-04

深度好文， 尤其是他分析问题的思路。Linux Load Averages: Solving the Mystery： http://www.brendangregg.com/blog/2017-08-08/linux-load-averages.html

**Way**

2018-12-16

Amazon EC2 Ubuntu 18.04 因为限制了repo源，运行apt install stress会遇到以下错误"E: Unable to locate package stress"解决方法:1) sudo nano /etc/apt/sources.list2) 添加以下三行到文件最底部, 然后保存并退出deb http://archive.ubuntu.com/ubuntu bionic main universedeb http://archive.ubuntu.com/ubuntu bionic-security main universe deb http://archive.ubuntu.com/ubuntu bionic-updates main universe3) sudo apt update4) sudo apt install stress5) 确认已安装$ stress --versionstress 1.0.4

**chenlingwx**

2018-12-07

老师您好！请教老师:最后的io密集场景二，mpstat显示sys为24％iowait为68％合计90％左右，为什么到pidstat里，stress进程却只显示35％左右的cpu？

作者回复: 进程没有iowait的概念，进程需要通过系统调用间接访问磁盘，而系统还需要通过I/O栈（后面会讲）来管理磁盘，所以有些CPU使用只能算在系统的头上
