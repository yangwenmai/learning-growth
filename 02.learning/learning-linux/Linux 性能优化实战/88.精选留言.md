## 精选留言

![](https://raw.githubusercontent.com/yangwenmai/learning-growth/master/assets/images/Linux%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98%E7%B2%BE%E9%80%89%E7%95%99%E8%A8%80%E8%B6%8B%E5%8A%BF%E5%9B%BE.png)

|小节|留言数|
|----|----|
|开篇词 - 别让Linxu性能问题成为你的绊脚石|748|
|01 - 如何学习Linux性能优化？|292|
|CPU性能篇|13讲|
|02 - 基础篇：到底应该怎么理解“平均负载”？|492|
|03 - 基础篇：经常说的 CPU 上下文切换是什么意思？(上) |266|
|04 - 基础篇：经常说的 CPU 上下文切换是什么意思？(下) |165|
|05 - 基础篇：某个应用的CPU使用率居然达到100%，我改怎么办？|237|
|06 - 案例篇：系统CPU使用率很高，但为啥却找不到高CPU的应用？|125|
|07 - 案例篇：系统中出现大量不可中断进程和僵尸进程怎么办？（上）|110|
|08 - 案例篇：系统中出现大量不可中断进程和僵尸进程怎么办？（下）|97|
|09 - 基础篇：怎么理解Linux软中断？|85|
|10 - 案例篇：系统的软中断CPU使用率升高，我该怎么办？|91|
|11 - 套路篇：如何迅速分析出系统CPU的瓶颈在哪里？|91|
|12 - 套路篇：CPU 性能优化的几个思路|56|
|13 - 答疑（一）：无法模拟出 RES 中断的问题，怎么办？|46|
|14 - 答疑（二）：如何用perf工具分析Java程序？|56|
|内存性能篇|8讲|
|15 - 基础篇：Linux内存是怎么工作的？|106|
|16 - 基础篇：怎么理解内存中的Buffer和Cache？|110|
|17 - 案例篇：如何利用系统缓存优化程序的运行效率？|94|
|18 - 案例篇：内存泄漏了，我该如何定位和处理？|92|
|19 - 案例篇：为什么系统的Swap变高了（上）|60|
|20 - 案例篇：为什么系统的Swap变高了？（下）|37|
|21 - 套路篇：如何“快准狠”找到系统内存的问题？|34|
|22 - 答疑（三）：文件系统与磁盘的区别是什么？|34|
|I/O 性能篇|10讲|
|23 - 基础篇：Linux 文件系统是怎么工作的？|59|
|24 - 基础篇：Linux 磁盘I/O是怎么工作的（上）|29|
|25 - 基础篇：Linux 磁盘I/O是怎么工作的（下）|32|
|26 - 案例篇：如何找出狂打日志的“内鬼”？|35|
|27 - 案例篇：为什么我的磁盘I/O延迟很高？|28|
|28 - 案例篇：一个SQL查询要15秒，这是怎么回事？|36|
|29 - 案例篇：Redis响应严重延迟，如何解决？|23|
|30 - 套路篇：如何迅速分析出系统I/O的瓶颈在哪里？|27|
|31 - 套路篇：磁盘 I/O 性能优化的几个思路|25|
|32 - 答疑（四）：阻塞、非阻塞 I/O 与同步、异步 I/O 的区别和联系|16|
|网络性能篇|13讲|
|33 - 关于 Linux 网络，你必须知道这些（上）|32|
|34 - 关于 Linux 网络，你必须知道这些（下）|41|
|35 - 基础篇：C10K 和 C1000K 回顾|42|
|36 - 套路篇：怎么评估系统的网络性能？|37|
|37 - 案例篇：DNS 解析时快时慢，我该怎么办？|25|
|38 - 案例篇：怎么使用 tcpdump 和 Wireshark 分析网络流量？|24|
|39 - 案例篇：怎么缓解 DDoS 攻击带来的性能下降问题？|31|
|40 - 案例篇：网络请求延迟变大了，我该怎么办？|26|
|41 - 案例篇：如何优化 NAT 性能？（上）|21|
|42 - 案例篇：如何优化 NAT 性能？（下）|26|
|43 - 套路篇：网络性能优化的几个思路（上）|27|
|44 - 套路篇：网络性能优化的几个思路（下）|26|
|45 - 答疑（五）：网络收发过程中，缓冲区位置在哪里？|16|
|综合实战篇|13讲|
|46 - 案例篇：为什么应用容器化后，启动慢了很多？|20|
|47 - 案例篇：服务器总是时不时丢包，我该怎么办？（上）|13|
|48 - 案例篇：服务器总是时不时丢包，我该怎么办？（下）|21|
|49 - 案例篇：内核线程 CPU 利用率太高，我该怎么办？|12|
|50 - 案例篇：动态追踪怎么用？（上）|23|
|51 - 案例篇：动态追踪怎么用？（下）|20|
|52 - 案例篇：服务吞吐量下降很厉害，怎么分析？|28|
|53 - 套路篇：系统监控的综合思路|26|
|54 - 套路篇：应用监控的一般思路|16|
|55 - 套路篇：分析性能问题的一般步骤|8|
|56 - 套路篇：优化性能问题的一般方法|10|
|57 - 套路篇：Linux 性能工具速查|10|
|58 - 答疑（六）：容器冷启动如何性能分析？|9|
|加餐篇|4讲|
|加餐（一） - 书单推荐：性能优化和Linux 系统原理|19|
|加餐（二） - 书单推荐：网络原理和 Linux 内核实现|17|
|用户故事 - “半路出家 ”，也要顺利拿下性能优化！|2|
|用户故事 - 运维和开发工程师们怎么说？|18|
|结束语 - 愿你攻克性能难关|54|
|结课测试 - 这些Linux性能知识你都掌握了吗？|3|

----

以下为各章节的精选留言中的精选摘录

### 到底应该怎么理解“平均负载”？

**倪朋飞**

2018-11-25

1. iowait无法升高的问题，是因为案例中stress使用的是 sync() 系统调用，它的作用是刷新缓冲区内存到磁盘中。对于新安装的虚拟机，缓冲区可能比较小，无法产生大的IO压力，这样大部分就都是系统调用的消耗了。所以，你会看到只有系统CPU使用率升高。解决方法是使用stress的下一代stress-ng，它支持更丰富的选项，比如 stress-ng -i 1 --hdd 1 --timeout 600（--hdd表示读写临时文件）。
2. pidstat输出中没有%wait的问题，是因为CentOS默认的sysstat稍微有点老，源码或者RPM升级到11.5.5版本以后就可以看到了。而Ubuntu的包一般都比较新，没有这个问题。
3. mpstat无法观测的问题，案例中是等待5秒后输出1次结果就停止了，更好的做法是持续监控一段时间，比如持续观测20次：mpstat -P ALL 5 20。

**冯宇：**

2018-11-23

我一直用htop看负载，因为它更直接（在F2配置中勾选所有开关项，打开颜色区分功能），不同的负载会用不同的颜色标识。比如cpu密集型的应用，它的负载颜色是绿色偏高，iowait的操作，它的负载颜色是红色偏高等等，根据这些指标再用htop的sort就很容易定位到有问题的进程。还有个更好用的atop命令，好像是基于sar的统计生成的报告，直接就把有问题的进程标红了，更直观

**shellmode**

2018-11-23

在 sched/loadavg.c 中计算平均值的算法为EMA，这种算法的目的主要是“距离目标预测窗口越近，则数据的价值越高，对未来影响越大”如果说“更快的计算”应该只有里面的 fixed_power_int 函数用 O(log n) 的时间来算 x^n所以内核中用 EMA 来算 loadavg 本质上并不是增加计算性能，而是让 loadavg 的趋势化更明显

**孤岛**

2018-11-23

我有一点自己的理解，请老师指正。CPU比喻成一辆地铁，正在使用CPU的进程就是在地铁上的人；等待CPU的进程就是在下一站等地铁来的人；等待I/O的进程就是在下一站要上车和下车的人，虽然现在对CPU没影响，可未来会影响，所以也要考虑到平均负载上。

作者回复: 很好的比喻，补充一下这个地铁的乘客容量就是CPU个数

**DJH**

2018-11-23

老师你好，请教一个问题，现在大多数CPU有超线程能力，在计算和评估平均负载的时候，CPU的核数是指物理核数，还是超线程功能的逻辑核数？

作者回复: 逻辑核数

**杨领well**

2019-06-04

深度好文， 尤其是他分析问题的思路。Linux Load Averages: Solving the Mystery： http://www.brendangregg.com/blog/2017-08-08/linux-load-averages.html

**Way**

2018-12-16

Amazon EC2 Ubuntu 18.04 因为限制了repo源，运行apt install stress会遇到以下错误"E: Unable to locate package stress"解决方法:1) sudo nano /etc/apt/sources.list2) 添加以下三行到文件最底部, 然后保存并退出deb http://archive.ubuntu.com/ubuntu bionic main universedeb http://archive.ubuntu.com/ubuntu bionic-security main universe deb http://archive.ubuntu.com/ubuntu bionic-updates main universe3) sudo apt update4) sudo apt install stress5) 确认已安装$ stress --versionstress 1.0.4

**chenlingwx**

2018-12-07

老师您好！请教老师:最后的io密集场景二，mpstat显示sys为24％iowait为68％合计90％左右，为什么到pidstat里，stress进程却只显示35％左右的cpu？

作者回复: 进程没有iowait的概念，进程需要通过系统调用间接访问磁盘，而系统还需要通过I/O栈（后面会讲）来管理磁盘，所以有些CPU使用只能算在系统的头上

### 怎么理解 CPU 上下文切换？

**小花**

2019-03-25

进程切换我想到了很多年前在银行柜台办理业务的情形。
1：银行分配各个窗口给来办理业务的人
2：如果只有1个窗口开放（系统资源不足），大部分都得等
3：如果正在办理业务的突然说自己不办了（sleep）,那他就去旁边再想想（等）
4：如果突然来了个VIP客户，可以强行插队
5：如果突然断电了（中断），都得等。。

**炀☁️**

2018-11-27

cpu上下文切换就好比一个人有好多朋友要拜访，有的朋友房子大（进程），进进出出里三层外三层，有的朋友住帐篷（线程），就拉开帐篷聊聊天，有的朋友就隔着窗户说两句话打个照面路过（中断）

**高峰**

2018-11-27

“其一，为了保证所有进程可以得到公平调度，CPU 时间被划分为一段段的时间片，这些时间片再被轮流分配给各个进程。”。
CFS 调度器没有时间片的概念了，叫做虚拟运行时间。
>CFS 是 Completely Fair Scheduler 的缩写。

**行者**

2018-11-28

结合前两节，首先通过uptime查看系统负载，然后使用mpstat结合pidstat来初步判断到底是cpu计算量大还是进程争抢过大或者是io过多，接着使用vmstat分析切换次数，以及切换类型，来进一步判断到底是io过多导致问题还是进程争抢激烈导致问题。

**cuikt**

2019-04-30

可以通过以下指令进行排序，观察RES。
watch -d 'cat /proc/interrupts | sort -nr -k 2 '

### 某个应用的CPU使用率居然达到100%，我改怎么办？

**喜哥**

2019-07-16

你好 老师通过perf查看kernel.kallsyms高达40%
如何分析呢
作者回复: 这是内核中将十六进制的符号地址转换成符号名称的模块，高是正常的，可以忽略

### 06？